{"version":3,"file":"extraReporters.js","names":["Mocha","_interopRequireWildcard","require","_nodeModule","_nodePath","_interopRequireDefault","e","__esModule","default","t","WeakMap","r","n","o","i","f","__proto__","has","get","set","_t","hasOwnProperty","call","Object","defineProperty","getOwnPropertyDescriptor","ownKeys","keys","getOwnPropertySymbols","filter","enumerable","push","apply","_objectSpread","arguments","length","forEach","_defineProperty","getOwnPropertyDescriptors","defineProperties","_toPropertyKey","value","configurable","writable","_toPrimitive","Symbol","toPrimitive","TypeError","String","Number","localRequire","createRequire","pathToFileURL","__filename","toString","enableExtraReporters","runner","options","extraReportersConfig","extraReporterEntries","Array","from","generateCanonicalizedReporterEntries","loadedReporterEntries","loadReporters","instantiateReporters","exports","doneAll","reporters","failures","fn","doneCallbacks","collectDoneCallbacks","callbacksToWait","onReporterIsDone","done","isReporterArrayEntry","resolveReporterArrayEntry","map","resolveReporterEntry","reporterEntries","_ref","moduleOrCtor","loadReporterModule","entries","Reporter","reporterOptions","optionsForReporter","reporter","bind","maybeReporterModuleOrCtor","maybeReporterOptions","builtInReporters","builtInReporterCtor","reporterModulePath","getReporterModulePath","Error","concat","message","module","resolve","path","reporterEntry"],"sources":["../../src/extraReporters.ts"],"sourcesContent":["import * as Mocha from \"mocha\";\nimport { createRequire } from \"node:module\";\nimport path from \"node:path\";\nimport type { ReporterDoneFn, ReporterEntry, ReporterModuleOrCtor, ReporterOptions } from \"./types.js\";\n\ntype CanonicalReporterEntry = readonly [ReporterModuleOrCtor, ReporterOptions];\ntype ShortReporterEntry = readonly [ReporterModuleOrCtor];\ntype LoadedReporterEntry = readonly [Mocha.ReporterConstructor, ReporterOptions];\n\n// There is no global require in ESM, and we can't use dynamic import (which returns a promise) because it's called from the reporter's constructor; therefore, it must be synchronous.\nconst localRequire = typeof require === \"function\" ? require : createRequire(import.meta.url);\n\nexport const enableExtraReporters = (\n  runner: Mocha.Runner,\n  options: Mocha.MochaOptions,\n  extraReportersConfig: ReporterEntry | readonly ReporterEntry[],\n) => {\n  const extraReporterEntries = Array.from(generateCanonicalizedReporterEntries(extraReportersConfig));\n  const loadedReporterEntries = loadReporters(extraReporterEntries);\n  return instantiateReporters(runner, options, loadedReporterEntries);\n};\n\nexport const doneAll = (\n  reporters: readonly Mocha.reporters.Base[],\n  failures: number,\n  fn?: ((failures: number) => void) | undefined,\n) => {\n  const doneCallbacks = collectDoneCallbacks(reporters);\n  let callbacksToWait = doneCallbacks.length + 1;\n  const onReporterIsDone = () => {\n    if (--callbacksToWait === 0) {\n      fn?.(failures);\n    }\n  };\n\n  for (const done of doneCallbacks) {\n    done(failures, onReporterIsDone);\n  }\n\n  onReporterIsDone(); // handle the synchronous completion\n};\n\nconst generateCanonicalizedReporterEntries = function* (\n  reporters: ReporterEntry | readonly ReporterEntry[] | undefined,\n): Generator<CanonicalReporterEntry, void, undefined> {\n  if (reporters) {\n    if (!(reporters instanceof Array)) {\n      yield [reporters, {}];\n    } else {\n      if (isReporterArrayEntry(reporters)) {\n        yield resolveReporterArrayEntry(reporters);\n      } else {\n        yield* reporters.map((e) => {\n          return resolveReporterEntry(e);\n        });\n      }\n    }\n  }\n};\n\nconst loadReporters = (reporterEntries: readonly CanonicalReporterEntry[]): LoadedReporterEntry[] =>\n  reporterEntries.map(([moduleOrCtor, options]) => [loadReporterModule(moduleOrCtor), options]);\n\nconst instantiateReporters = (\n  runner: Mocha.Runner,\n  options: Mocha.MochaOptions,\n  entries: readonly LoadedReporterEntry[],\n) => {\n  const reporters: Mocha.reporters.Base[] = [];\n  for (const [Reporter, reporterOptions] of entries) {\n    const optionsForReporter = {\n      ...options,\n      reporterOptions,\n      // eslint-disable-next-line quote-props\n      \"reporterOption\": reporterOptions,\n      \"reporter-option\": reporterOptions,\n    };\n    reporters.push(new Reporter(runner, optionsForReporter));\n  }\n  return reporters;\n};\n\nconst collectDoneCallbacks = (reporters: readonly Mocha.reporters.Base[]) => {\n  const doneCallbacks: ReporterDoneFn[] = [];\n  for (const reporter of reporters) {\n    if (reporter.done) {\n      doneCallbacks.push(reporter.done.bind(reporter));\n    }\n  }\n  return doneCallbacks;\n};\n\nconst isReporterArrayEntry = (\n  reporters: ShortReporterEntry | CanonicalReporterEntry | readonly ReporterEntry[],\n): reporters is ShortReporterEntry | CanonicalReporterEntry => {\n  const [maybeReporterModuleOrCtor, maybeReporterOptions = {}] = reporters;\n  return (\n    !(maybeReporterModuleOrCtor instanceof Array) &&\n    typeof maybeReporterOptions === \"object\" &&\n    !(maybeReporterOptions instanceof Array)\n  );\n};\n\nconst loadReporterModule = (moduleOrCtor: ReporterModuleOrCtor) => {\n  if (typeof moduleOrCtor === \"string\") {\n    const builtInReporters = Mocha.reporters as Record<string, Mocha.ReporterConstructor>;\n    const builtInReporterCtor = builtInReporters[moduleOrCtor];\n    if (builtInReporterCtor) {\n      return builtInReporterCtor;\n    }\n\n    const reporterModulePath = getReporterModulePath(moduleOrCtor);\n    try {\n      return localRequire(reporterModulePath) as Mocha.ReporterConstructor;\n    } catch (e: any) {\n      throw new Error(`Can't load the '${moduleOrCtor}' reporter from ${reporterModulePath}: ${e.message}`);\n    }\n  }\n\n  if (typeof moduleOrCtor !== \"function\") {\n    throw new Error(`A reporter value must be a string or a constructor. Got ${typeof moduleOrCtor}`);\n  }\n\n  return moduleOrCtor;\n};\n\nconst getReporterModulePath = (module: string) => {\n  try {\n    return localRequire.resolve(module);\n  } catch (e) {}\n\n  try {\n    return path.resolve(module);\n  } catch (e: any) {\n    throw new Error(`Can't resolve the '${module}' reporter's path: ${e.message}`);\n  }\n};\n\nconst resolveReporterEntry = (reporterEntry: ReporterEntry): CanonicalReporterEntry => {\n  return reporterEntry instanceof Array ? resolveReporterArrayEntry(reporterEntry) : [reporterEntry, {}];\n};\n\nconst resolveReporterArrayEntry = (\n  reporterEntry: ShortReporterEntry | CanonicalReporterEntry,\n): CanonicalReporterEntry => {\n  if (reporterEntry.length < 1 || reporterEntry.length > 2) {\n    throw new Error(\n      `If an extra reporter entry is an array, it must contain one or two elements. ${reporterEntry.length} found`,\n    );\n  }\n\n  return reporterEntry.length === 1 ? [...reporterEntry, {}] : [...reporterEntry];\n};\n"],"mappings":"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","ignoreList":[]}